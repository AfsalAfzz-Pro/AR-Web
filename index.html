<!DOCTYPE html>
<html>
<head>
    <title>AR Profile Card</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script>
        AFRAME.registerComponent('ar-scene-manager', {
            init: function() {
                this.placedObjects = false;
                this.cameraEl = document.querySelector('[camera]');
                
                // Add tap to place functionality
                document.addEventListener('click', () => {
                    if (!this.placedObjects) {
                        this.placeObjects();
                    }
                });

                // Show placement instructions
                const instructions = document.createElement('div');
                instructions.className = 'instructions';
                instructions.innerHTML = 'Tap anywhere to place the profile card';
                document.body.appendChild(instructions);
            },

            placeObjects: function() {
                const scene = this.el;
                const camera = this.cameraEl;
                const worldPos = new THREE.Vector3();
                camera.object3D.getWorldPosition(worldPos);

                // Create container for all content
                const container = document.createElement('a-entity');
                container.setAttribute('position', `${worldPos.x} ${worldPos.y} ${worldPos.z - 2}`); // Place 2 units in front
                container.setAttribute('look-at', '[camera]');
                container.setAttribute('gesture-handler', '');

                // Add your existing content here
                container.innerHTML = `
                    <!-- 3D Avatar -->
                    <a-entity
                        gltf-model="#avatar"
                        position="0 0 0"
                        scale="0.7 0.7 0.7"
                        animation-mixer="clip: *; timeScale: 0.5"
                        animation__rotate="property: rotation; to: 0 360 0; dur: 15000; easing: linear; loop: true">
                    </a-entity>

                    <!-- Floating Text Elements -->
                    <a-entity position="1.2 0.8 0">
                        <!-- Name -->
                        <a-text 
                            value="John Developer"
                            position="0 0.6 0"
                            color="#FF0000"
                            scale="1 1 1"
                            align="center"
                            animation="property: position; to: 0 0.7 0; dur: 2000; dir: alternate; easing: easeInOutQuad; loop: true">
                        </a-text>

                        <!-- Title -->
                        <a-text
                            value="AR/VR Developer & Designer"
                            position="0 0.2 0"
                            color="yellow"
                            scale="0.6 0.6 0.6"
                            align="center"
                            animation="property: position; to: 0 0.3 0; dur: 2000; dir: alternate; easing: easeInOutQuad; loop: true; delay: 200">
                        </a-text>

                        <!-- Skills -->
                        <a-entity position="0 -0.3 0"
                            animation="property: position; to: 0 -0.2 0; dur: 2000; dir: alternate; easing: easeInOutQuad; loop: true; delay: 400">
                            <a-text
                                value="âš¡ WebXR\nðŸŽ® Three.js\nðŸŒ Full Stack\nðŸŽ¨ 3D Design"
                                color="cyan"
                                scale="0.4 0.4 0.4"
                                align="center"
                                baseline="center">
                            </a-text>
                        </a-entity>

                        <!-- Social Links -->
                        <a-entity position="0 -1 0"
                            animation="property: position; to: 0 -0.9 0; dur: 2000; dir: alternate; easing: easeInOutQuad; loop: true; delay: 600">
                            <a-text
                                value="ðŸ“§ hello@example.com\nðŸŒ portfolio.dev\nðŸ’¼ github.com/dev"
                                color="#4CC3D9"
                                scale="0.35 0.35 0.35"
                                align="center"
                                baseline="center"
                                class="clickable"
                                clickable>
                            </a-text>
                        </a-entity>
                    </a-entity>
                `;

                scene.appendChild(container);
                this.placedObjects = true;

                // Hide instructions
                document.querySelector('.instructions').style.display = 'none';
            }
        });

        // Performance optimization: Disable WebGL antialiasing on mobile
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        AFRAME.registerComponent('optimize-for-device', {
            init: function () {
                const sceneEl = this.el;
                if (isMobile) {
                    sceneEl.setAttribute('renderer', {
                        antialias: false,
                        precision: 'mediump',
                        powerPreference: 'high-performance'
                    });
                }
            }
        });

        // Touch gesture handling
        AFRAME.registerComponent('gesture-handler', {
            schema: {
                enabled: { default: true },
                rotationFactor: { default: 5 },
                minScale: { default: 0.3 },
                maxScale: { default: 8 },
            },

            init: function() {
                this.handleScale = this.handleScale.bind(this);
                this.handleRotation = this.handleRotation.bind(this);

                this.isVisible = false;
                this.initialScale = this.el.object3D.scale.clone();
                this.scaleFactor = 1;

                this.el.sceneEl.addEventListener('markerFound', (e) => {
                    this.isVisible = true;
                });
                this.el.sceneEl.addEventListener('markerLost', (e) => {
                    this.isVisible = false;
                });
            },

            update: function() {
                if (this.data.enabled) {
                    this.el.sceneEl.addEventListener('touchmove', this.handleRotation);
                    this.el.sceneEl.addEventListener('gesturestart', this.handleScale);
                    this.el.sceneEl.addEventListener('gesturechange', this.handleScale);
                }
            },

            handleRotation: function(event) {
                if (event.touches.length === 1 && this.isVisible) {
                    event.preventDefault();
                    const touch = event.touches[0];
                    this.el.object3D.rotation.y +=
                        (touch.movementX || touch.mozMovementX || 0) / 50;
                }
            },

            handleScale: function(event) {
                if (this.isVisible) {
                    event.preventDefault();
                    this.scaleFactor *=
                        1 + (event.scale - 1) * this.data.rotationFactor;
                    this.scaleFactor = Math.min(
                        Math.max(this.scaleFactor, this.data.minScale),
                        this.data.maxScale
                    );

                    this.el.object3D.scale.x = this.scaleFactor * this.initialScale.x;
                    this.el.object3D.scale.y = this.scaleFactor * this.initialScale.y;
                    this.el.object3D.scale.z = this.scaleFactor * this.initialScale.z;
                }
            },

            remove: function() {
                this.el.sceneEl.removeEventListener('touchmove', this.handleRotation);
                this.el.sceneEl.removeEventListener('gesturestart', this.handleScale);
                this.el.sceneEl.removeEventListener('gesturechange', this.handleScale);
            }
        });

        // Enhanced clickable component with haptic feedback
        AFRAME.registerComponent('clickable', {
            init: function () {
                this.el.addEventListener('click', (evt) => {
                    this.setAttribute('scale', {x: 1.2, y: 1.2, z: 1.2});
                    
                    // Haptic feedback
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }

                    setTimeout(() => {
                        this.setAttribute('scale', {x: 1, y: 1, z: 1});
                    }, 300);
                });

                // Add touch feedback
                if (isMobile) {
                    this.el.addEventListener('touchstart', (evt) => {
                        evt.preventDefault();
                        this.el.emit('click', {}, false);
                    });
                }
            }
        });

        AFRAME.registerComponent('color-toggle', {
            init: function () {
                let el = this.el;
                let colors = ['#4CC3D9', '#ff9500'];
                let index = 0;
                
                // Performance optimization: Use requestAnimationFrame
                let lastToggle = 0;
                const toggle = (timestamp) => {
                    if (timestamp - lastToggle >= 1000) {
                        index = (index + 1) % colors.length;
                        el.setAttribute('color', colors[index]);
                        lastToggle = timestamp;
                    }
                    requestAnimationFrame(toggle);
                };
                requestAnimationFrame(toggle);
            }
        });

        AFRAME.registerComponent('marker-handler', {
            init: function () {
                const marker = this.el;
                const loading = document.querySelector('#loading');
                const sceneEl = document.querySelector('a-scene');

                // Performance optimization: Throttle marker updates
                let lastUpdate = 0;
                const updateThreshold = 100; // ms

                marker.addEventListener('markerFound', () => {
                    const now = performance.now();
                    if (now - lastUpdate > updateThreshold) {
                        loading.style.display = 'none';
                        // Haptic feedback on marker detection
                        if (navigator.vibrate) {
                            navigator.vibrate([100, 50, 100]);
                        }
                        lastUpdate = now;
                    }
                });

                marker.addEventListener('markerLost', () => {
                    const now = performance.now();
                    if (now - lastUpdate > updateThreshold) {
                        loading.style.display = 'flex';
                        lastUpdate = now;
                    }
                });

                // Handle iOS permissions
                if (DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const button = document.createElement('button');
                    button.innerHTML = 'Enable AR';
                    button.classList.add('permission-button');
                    document.body.appendChild(button);

                    button.addEventListener('click', function() {
                        DeviceOrientationEvent.requestPermission()
                            .then(response => {
                                if (response === 'granted') {
                                    button.style.display = 'none';
                                    if (navigator.vibrate) {
                                        navigator.vibrate(50);
                                    }
                                }
                            })
                            .catch(console.error);
                    });
                }

                // Add battery optimization
                if (navigator.getBattery) {
                    navigator.getBattery().then(battery => {
                        if (battery.level < 0.2) {
                            // Reduce animation quality when battery is low
                            document.querySelector('a-scene').setAttribute('renderer', 'precision', 'lowp');
                        }
                    });
                }
            }
        });

        // Add service worker for better performance
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(console.error);
            });
        }
    </script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene
        ar-scene-manager
        vr-mode-ui="enabled: false"
        renderer="antialias: true; logarithmicDepthBuffer: true; precision: mediump; powerPreference: high-performance"
        loading="enabled: false">
        
        <a-assets timeout="30000">
            <a-asset-item id="avatar" src="https://cdn.glitch.com/36cb8393-65c6-408d-a538-055ada20431b/Astronaut.glb?v=1542147958948"></a-asset-item>
            <img id="particle" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ1IDc5LjE2MzQ5OSwgMjAxOC8wOC8xMy0xNjo0MDoyMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjQ5MkVGRDY5QzM3QzExRUE5RkZDQTJGMzQ5QjY1REE4IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjQ5MkVGRDZBQzM3QzExRUE5RkZDQTJGMzQ5QjY1REE4Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NDkyRUZENjdDMzdDMTFFQTlGRkNBMkYzNDlCNjVEQTgiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NDkyRUZENjhDMzdDMTFFQTlGRkNBMkYzNDlCNjVEQTgiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz4zD1ZIAAAAZklEQVR42mL8//8/w0ACJoYBBqMOGHXAqANGHTDqgFEHjDpg1AGjDhh1wKgDRh0w6oBRB4w6YNQBow4YdcCoA0YdMOqAUQeMOmDUAaMOGHXAqANGHTDqgFEHjDpg1AEDDgACDABh/nutdcFPRAAAAABJRU5ErkJggg==">
        </a-assets>

        <!-- Enhanced Sky with Stars and Planets -->
        <a-sky color="#000000">
            <!-- Star System -->
            <a-entity position="0 0 0" star-system="count: 2000; radius: 250; depth: 0; size: 0.1, 0.5"></a-entity>
            
            <!-- Planets -->
            <a-sphere position="-50 30 -100" radius="5" material="shader: flat; color: #FF6B6B" planet="speed: 0.01"></a-sphere>
            <a-sphere position="70 -20 -150" radius="8" material="shader: flat; color: #4ECDC4" planet="speed: 0.015"></a-sphere>
            <a-sphere position="-30 -40 -200" radius="12" material="shader: flat; color: #FFE66D" planet="speed: 0.008"></a-sphere>
            
            <!-- Shooting Stars Container -->
            <a-entity id="shooting-stars"></a-entity>
        </a-sky>

        <!-- Camera with controls -->
        <a-entity 
            camera
            position="0 1.6 0"
            look-controls="pointerLockEnabled: false"
            wasd-controls-enabled="false">
        </a-entity>

        <!-- Grid Floor -->
        <a-grid
            material="shader: flat; color: #2A3B4C; opacity: 0.3"
            rotation="-90 0 0"
            position="0 -0.1 0"
            scale="5 5 5"
            animation="property: material.opacity; to: 0.4; dur: 2000; dir: alternate; easing: easeInOutQuad; loop: true">
        </a-grid>

        <!-- Main Content Container -->
        <a-entity position="0 0 -2">
            <!-- Ambient Particles -->
            <a-entity particle-system="preset: dust; particleCount: 50; color: #2A3B4C,#4A90E2; size: 0.02,0.05; texture: #particle; velocityValue: 0.05 0.05 0.05; accelerationValue: 0 -0.01 0"></a-entity>

            <!-- Avatar with Ground Effects -->
            <a-entity
                gltf-model="#avatar"
                position="0 0 0"
                scale="0.7 0.7 0.7"
                animation-mixer="clip: *; timeScale: 0.5"
                animation__rotate="property: rotation; to: 0 360 0; dur: 15000; easing: linear; loop: true">
                
                <!-- Ground Glow Effect -->
                <a-ring
                    position="0 0.01 0"
                    rotation="-90 0 0"
                    radius-inner="0.5"
                    radius-outer="1"
                    material="shader: flat; color: #4A90E2; opacity: 0.3"
                    animation="property: material.opacity; to: 0.1; dur: 2000; dir: alternate; easing: easeInOutQuad; loop: true">
                </a-ring>
            </a-entity>
        </a-entity>

    </a-scene>

    <!-- Loading Screen -->
    <div id="loading" style="display: none;">
        <div class="loading-text">
            Loading AR Experience...
            <br><br>
            <small>Tap anywhere to place the astronaut</small>
        </div>
    </div>

    <script>
        // Star system component with enhanced features
        AFRAME.registerComponent('star-system', {
            schema: {
                count: { type: 'number', default: 2000 },
                radius: { type: 'number', default: 250 },
                depth: { type: 'number', default: 0 },
                size: { type: 'array', default: [0.1, 0.5] }
            },
            init: function () {
                let material = new THREE.PointsMaterial({
                    color: 0xFFFFFF,
                    size: this.data.size[0],
                    sizeAttenuation: true,
                    transparent: true,
                    blending: THREE.AdditiveBlending
                });
                let geometry = new THREE.BufferGeometry();
                let positions = [];
                
                for (let i = 0; i < this.data.count; i++) {
                    const radius = THREE.MathUtils.randFloat(0, this.data.radius);
                    const theta = THREE.MathUtils.randFloat(0, Math.PI * 2);
                    const phi = THREE.MathUtils.randFloat(0, Math.PI);
                    
                    positions.push(
                        radius * Math.sin(phi) * Math.cos(theta),
                        radius * Math.sin(phi) * Math.sin(theta),
                        radius * Math.cos(phi)
                    );
                }
                
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                this.el.setObject3D('star-system', new THREE.Points(geometry, material));
            }
        });

        // Planet rotation component
        AFRAME.registerComponent('planet', {
            schema: {
                speed: { type: 'number', default: 0.01 }
            },
            tick: function () {
                this.el.object3D.rotation.y += this.data.speed;
            }
        });

        // Shooting star system
        function createShootingStar() {
            const star = document.createElement('a-entity');
            const startX = Math.random() * 400 - 200;
            const startY = Math.random() * 200 + 50;
            const startZ = -200;
            
            star.setAttribute('position', `${startX} ${startY} ${startZ}`);
            star.setAttribute('particle-system', {
                preset: 'streak',
                particleCount: 20,
                color: '#FFF',
                size: 0.2,
                velocity: '2 -1 1',
                acceleration: '0 -2 0',
                lifetime: 1,
                opacity: { value: 1, spread: 0 }
            });

            document.querySelector('#shooting-stars').appendChild(star);
            
            setTimeout(() => {
                star.parentNode.removeChild(star);
            }, 2000);
        }

        // Create shooting stars periodically
        setInterval(createShootingStar, 3000);
    </script>
</body>
</html> 